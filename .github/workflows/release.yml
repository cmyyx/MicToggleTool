name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.2)'
        required: true
        type: string

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version
      id: get_version
      run: |
        # åˆ¤æ–­æ˜¯æ‰‹åŠ¨è§¦å‘è¿˜æ˜¯æ ‡ç­¾è§¦å‘
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
          echo "Manual trigger with version: $version"
        } else {
          $version = "${{ github.ref_name }}" -replace '^v', ''
          echo "Tag trigger with version: $version"
        }
        
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "TAG=v$version" >> $env:GITHUB_OUTPUT
        echo "Final version: $version"
      shell: pwsh
      
    - name: Update version in script
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $parts = $version.Split('.')
        $major = $parts[0]
        $minor = $parts[1]
        $patch = $parts[2]
        $fullVersion = "$major.$minor.$patch.0"
        $date = Get-Date -Format "yyyy-MM-dd"
        $year = Get-Date -Format "yyyy"
        
        echo "Version: $fullVersion"
        echo "Date: $date"
        echo "Year: $year"
        
        # è¯»å–æ–‡ä»¶å†…å®¹
        $content = Get-Content "MicToggleTool.ahk" -Raw -Encoding UTF8
        
        # æ›¿æ¢ç‰ˆæœ¬å·å ä½ç¬¦
        $content = $content -replace 'VERSION_MAJOR', $major
        $content = $content -replace 'VERSION_MINOR', $minor
        $content = $content -replace 'VERSION_PATCH', $patch
        $content = $content -replace 'VERSION_FULL', $fullVersion
        $content = $content -replace 'RELEASE_DATE', $date
        $content = $content -replace 'COPYRIGHT_YEAR', $year
        
        # ä¿å­˜æ–‡ä»¶
        Set-Content "MicToggleTool.ahk" -Value $content -Encoding UTF8 -NoNewline
        
        echo "âœ“ Version updated to $fullVersion"
        echo "âœ“ Release date set to $date"
        echo "âœ“ Copyright year set to $year"
      shell: pwsh
      
    - name: Setup AutoHotkey
      run: |
        # ä¸‹è½½ AutoHotkey v2
        Invoke-WebRequest -Uri "https://www.autohotkey.com/download/ahk-v2.zip" -OutFile "ahk.zip"
        Expand-Archive -Path "ahk.zip" -DestinationPath "AutoHotkey"
        
        # å…‹éš† Ahk2Exe ä»“åº“
        git clone --depth 1 https://github.com/AutoHotkey/Ahk2Exe.git Ahk2Exe-Repo
        
        # å¤åˆ¶ Ahk2Exe åˆ° AutoHotkey ç›®å½•
        New-Item -ItemType Directory -Path "AutoHotkey\Compiler" -Force
        Copy-Item -Path "Ahk2Exe-Repo\*" -Destination "AutoHotkey\Compiler\" -Recurse -Force
        
        # éªŒè¯æ–‡ä»¶
        if (Test-Path "AutoHotkey\Compiler\Ahk2Exe.ahk") {
          echo "Ahk2Exe setup successful"
        } else {
          echo "Ahk2Exe setup failed"
          exit 1
        }
      shell: pwsh
      
    - name: Compile executable
      run: |
        $ahk = "AutoHotkey\AutoHotkey64.exe"
        $ahk2exe = "AutoHotkey\Compiler\Ahk2Exe.ahk"
        
        # ä½¿ç”¨ AutoHotkey è¿è¡Œ Ahk2Exe.ahk è¿›è¡Œç¼–è¯‘
        & $ahk $ahk2exe /in "MicToggleTool.ahk" /out "MicToggleTool.exe" /icon "icons\mic_enabled.ico"
        
        # ç­‰å¾…ç¼–è¯‘å®Œæˆ
        Start-Sleep -Seconds 5
      shell: pwsh
      
    - name: Verify build
      id: verify
      run: |
        if (Test-Path "MicToggleTool.exe") {
          $size = (Get-Item "MicToggleTool.exe").Length
          $sizeMB = [math]::Round($size / 1MB, 2)
          echo "SIZE_BYTES=$size" >> $env:GITHUB_OUTPUT
          echo "SIZE_MB=$sizeMB" >> $env:GITHUB_OUTPUT
          echo "Build successful! File size: $size bytes ($sizeMB MB)"
        } else {
          echo "Build failed! MicToggleTool.exe not found"
          exit 1
        }
      shell: pwsh
      
    - name: Calculate SHA256
      id: sha256
      run: |
        $hash = (Get-FileHash -Path "MicToggleTool.exe" -Algorithm SHA256).Hash
        echo "SHA256=$hash" >> $env:GITHUB_OUTPUT
        
        # åˆ›å»º SHA256 æ–‡ä»¶
        $sha256Content = "$hash  MicToggleTool.exe"
        Set-Content "MicToggleTool.exe.sha256" -Value $sha256Content -Encoding ASCII -NoNewline
        
        echo "âœ“ SHA256: $hash"
        echo "âœ“ SHA256 file created: MicToggleTool.exe.sha256"
      shell: pwsh
      
    - name: Generate changelog
      id: changelog
      run: |
        try {
          # è·å–æ‰€æœ‰æ ‡ç­¾
          $allTags = git tag --sort=-version:refname
          
          if ($allTags.Count -eq 0) {
            # æ²¡æœ‰ä»»ä½•æ ‡ç­¾ï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡å‘å¸ƒ
            echo "No existing tags found - First release"
            
            # è·å–æ‰€æœ‰æäº¤è®°å½•
            $commits = git log --pretty=format:"- %s (%h)" --no-merges
            
            if ($commits) {
              $changelog = "é¦–æ¬¡å‘å¸ƒ`n`n" + ($commits -join "`n")
            } else {
              $changelog = "- é¦–æ¬¡å‘å¸ƒ"
            }
          }
          elseif ($allTags.Count -eq 1) {
            # åªæœ‰ä¸€ä¸ªæ ‡ç­¾ï¼ˆå½“å‰è¦å‘å¸ƒçš„ï¼‰ï¼Œè·å–ä»åˆå§‹æäº¤åˆ°ç°åœ¨çš„æ‰€æœ‰è®°å½•
            echo "Only one tag found - Getting all commits"
            
            $commits = git log --pretty=format:"- %s (%h)" --no-merges
            
            if ($commits) {
              $changelog = $commits -join "`n"
            } else {
              $changelog = "- é¦–æ¬¡å‘å¸ƒ"
            }
          }
          else {
            # æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œè·å–æœ€æ–°ä¸¤ä¸ªæ ‡ç­¾ä¹‹é—´çš„æäº¤
            $latestTag = $allTags[0]
            $previousTag = $allTags[1]
            
            echo "Generating changelog from $previousTag to $latestTag"
            
            # è·å–ä¸¤ä¸ªæ ‡ç­¾ä¹‹é—´çš„æäº¤è®°å½•
            $commits = git log "$previousTag..$latestTag" --pretty=format:"- %s (%h)" --no-merges
            
            if ($commits) {
              $changelog = $commits -join "`n"
            } else {
              $changelog = "- æ— æ–°æäº¤"
            }
          }
        }
        catch {
          echo "Error generating changelog: $_"
          $changelog = "- é¦–æ¬¡å‘å¸ƒ"
        }
        
        # ä¿å­˜åˆ°æ–‡ä»¶
        $changelog | Out-File -FilePath "CHANGELOG.txt" -Encoding UTF8 -NoNewline
        
        echo "âœ“ Changelog generated"
        echo "Changelog:"
        echo $changelog
      shell: pwsh
      
    - name: Prepare release body
      run: |
        $changelog = Get-Content "CHANGELOG.txt" -Raw -Encoding UTF8
        
        $body = @"
## MicToggleTool v${{ steps.get_version.outputs.VERSION }}

### ğŸ“ æ›´æ–°æ—¥å¿—

$changelog

### ğŸ“¥ ä¸‹è½½

- **Windows 64-bit**: [MicToggleTool.exe](https://github.com/cmyyx/MicToggleTool/releases/download/v${{ steps.get_version.outputs.VERSION }}/MicToggleTool.exe)
- **SHA256 æ ¡éªŒæ–‡ä»¶**: [MicToggleTool.exe.sha256](https://github.com/cmyyx/MicToggleTool/releases/download/v${{ steps.get_version.outputs.VERSION }}/MicToggleTool.exe.sha256)
- **æ–‡ä»¶å¤§å°**: ${{ steps.verify.outputs.SIZE_MB }} MB (${{ steps.verify.outputs.SIZE_BYTES }} bytes)
- **SHA256**: ``${{ steps.sha256.outputs.SHA256 }}``

### âœ… æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§

``````powershell
# Windows PowerShell
`$hash = (Get-FileHash -Path "MicToggleTool.exe" -Algorithm SHA256).Hash
`$expected = Get-Content "MicToggleTool.exe.sha256" | ForEach-Object { `$_.Split()[0] }
if (`$hash -eq `$expected) { Write-Host "âœ“ æ ¡éªŒé€šè¿‡" -ForegroundColor Green } else { Write-Host "âœ— æ ¡éªŒå¤±è´¥" -ForegroundColor Red }
``````

### ğŸš€ å¿«é€Ÿå¼€å§‹

1. ä¸‹è½½ `MicToggleTool.exe`
2. ï¼ˆå¯é€‰ï¼‰ä¸‹è½½ `MicToggleTool.exe.sha256` å¹¶æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
3. åŒå‡»è¿è¡Œï¼Œæˆäºˆç®¡ç†å‘˜æƒé™
4. é€‰æ‹©è¦æ§åˆ¶çš„éº¦å…‹é£è®¾å¤‡
5. æŒ‰ F9 åˆ‡æ¢éº¦å…‹é£çŠ¶æ€

### ğŸ“– å®Œæ•´æ–‡æ¡£

æŸ¥çœ‹ [README.md](https://github.com/cmyyx/MicToggleTool/blob/main/README.md) äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚

### ğŸ› é—®é¢˜åé¦ˆ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/cmyyx/MicToggleTool/issues) é¡µé¢æäº¤ã€‚
"@
        
        Set-Content "RELEASE_BODY.md" -Value $body -Encoding UTF8
      shell: pwsh
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.TAG }}
        name: v${{ steps.get_version.outputs.VERSION }}
        body_path: RELEASE_BODY.md
        files: |
          MicToggleTool.exe
          MicToggleTool.exe.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
