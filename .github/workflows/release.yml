name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.2, ç•™ç©ºåˆ™ä½¿ç”¨æœ€æ–° tag)'
        required: false
        type: string

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version
      id: get_version
      run: |
        # åˆ¤æ–­æ˜¯æ‰‹åŠ¨è§¦å‘è¿˜æ˜¯æ ‡ç­¾è§¦å‘
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $inputVersion = "${{ github.event.inputs.version }}"
          
          if ([string]::IsNullOrWhiteSpace($inputVersion)) {
            # å¦‚æœæ²¡æœ‰æä¾›ç‰ˆæœ¬å·ï¼Œä½¿ç”¨æœ€æ–°çš„ tag
            $latestTag = git describe --tags --abbrev=0 2>$null
            
            if ([string]::IsNullOrWhiteSpace($latestTag)) {
              echo "Error: No version provided and no tags found"
              exit 1
            }
            
            $version = $latestTag -replace '^v', ''
            echo "Manual trigger without version - using latest tag: $version"
          } else {
            $version = $inputVersion
            echo "Manual trigger with version: $version"
          }
        } else {
          $version = "${{ github.ref_name }}" -replace '^v', ''
          echo "Tag trigger with version: $version"
        }
        
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "TAG=v$version" >> $env:GITHUB_OUTPUT
        echo "Final version: $version"
      shell: pwsh
      
    - name: Update version in script
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $parts = $version.Split('.')
        $major = $parts[0]
        $minor = $parts[1]
        $patch = $parts[2]
        $fullVersion = "$major.$minor.$patch.0"
        $date = Get-Date -Format "yyyy-MM-dd"
        $year = Get-Date -Format "yyyy"
        
        echo "Version: $fullVersion"
        echo "Date: $date"
        echo "Year: $year"
        
        # è¯»å–æ–‡ä»¶å†…å®¹
        $content = Get-Content "MicToggleTool.ahk" -Raw -Encoding UTF8
        
        # æ›¿æ¢ç‰ˆæœ¬å·å ä½ç¬¦
        $content = $content -replace 'VERSION_MAJOR', $major
        $content = $content -replace 'VERSION_MINOR', $minor
        $content = $content -replace 'VERSION_PATCH', $patch
        $content = $content -replace 'VERSION_FULL', $fullVersion
        $content = $content -replace 'RELEASE_DATE', $date
        $content = $content -replace 'COPYRIGHT_YEAR', $year
        
        # ä¿å­˜æ–‡ä»¶
        Set-Content "MicToggleTool.ahk" -Value $content -Encoding UTF8 -NoNewline
        
        echo "âœ“ Version updated to $fullVersion"
        echo "âœ“ Release date set to $date"
        echo "âœ“ Copyright year set to $year"
      shell: pwsh
      
    - name: Setup AutoHotkey and Ahk2Exe
      run: |
        # è·å– AutoHotkey æœ€æ–°ç‰ˆæœ¬
        echo "Getting latest AutoHotkey release..."
        $ahkApiUrl = "https://api.github.com/repos/AutoHotkey/AutoHotkey/releases/latest"
        $ahkRelease = Invoke-RestMethod -Uri $ahkApiUrl -Headers @{ "User-Agent" = "Mozilla/5.0" }
        $ahkVersion = $ahkRelease.tag_name
        $ahkAsset = $ahkRelease.assets | Where-Object { $_.name -like "AutoHotkey_*.zip" } | Select-Object -First 1
        
        if ($ahkAsset) {
          echo "Latest AutoHotkey version: $ahkVersion"
          echo "Download URL: $($ahkAsset.browser_download_url)"
          
          # ä¸‹è½½ AutoHotkey
          Invoke-WebRequest -Uri $ahkAsset.browser_download_url -OutFile "ahk.zip" -UserAgent "Mozilla/5.0"
          
          echo "Extracting AutoHotkey..."
          Expand-Archive -Path "ahk.zip" -DestinationPath "AutoHotkey" -Force
          
          # éªŒè¯ AutoHotkey64.exe
          if (Test-Path "AutoHotkey\AutoHotkey64.exe") {
            echo "âœ“ AutoHotkey64.exe found"
          } else {
            echo "âœ— AutoHotkey64.exe not found"
            exit 1
          }
        } else {
          echo "âœ— Could not find AutoHotkey release asset"
          exit 1
        }
        
        # è·å– Ahk2Exe æœ€æ–°ç‰ˆæœ¬
        echo "Getting latest Ahk2Exe release..."
        $apiUrl = "https://api.github.com/repos/AutoHotkey/Ahk2Exe/releases/latest"
        $release = Invoke-RestMethod -Uri $apiUrl -Headers @{ "User-Agent" = "Mozilla/5.0" }
        $ahk2exeVersion = $release.tag_name
        $ahk2exeAsset = $release.assets | Where-Object { $_.name -like "*.zip" } | Select-Object -First 1
        
        if ($ahk2exeAsset) {
          echo "Latest Ahk2Exe version: $ahk2exeVersion"
          echo "Download URL: $($ahk2exeAsset.browser_download_url)"
          
          # ä¸‹è½½ Ahk2Exe
          Invoke-WebRequest -Uri $ahk2exeAsset.browser_download_url -OutFile "ahk2exe.zip" -UserAgent "Mozilla/5.0"
          
          echo "Extracting Ahk2Exe..."
          Expand-Archive -Path "ahk2exe.zip" -DestinationPath "Compiler" -Force
          
          # æŸ¥æ‰¾ Ahk2Exe.exe
          $ahk2exeFile = Get-ChildItem -Path "Compiler" -Filter "Ahk2Exe.exe" -Recurse | Select-Object -First 1
          if ($ahk2exeFile) {
            echo "âœ“ Ahk2Exe.exe found at: $($ahk2exeFile.FullName)"
            
            # å¦‚æœä¸åœ¨æ ¹ç›®å½•ï¼Œç§»åŠ¨åˆ°æ ¹ç›®å½•
            if ($ahk2exeFile.Directory.FullName -ne (Get-Location).Path + "\Compiler") {
              Move-Item -Path $ahk2exeFile.FullName -Destination "Compiler\Ahk2Exe.exe" -Force
            }
          } else {
            echo "âœ— Ahk2Exe.exe not found in downloaded archive"
            echo "Archive contents:"
            Get-ChildItem "Compiler" -Recurse | Select-Object FullName
            exit 1
          }
          
          # éªŒè¯ Ahk2Exe.exe æ˜¯å¦å­˜åœ¨
          if (Test-Path "Compiler\Ahk2Exe.exe") {
            echo "âœ“ Ahk2Exe.exe ready"
          } else {
            echo "âœ— Ahk2Exe.exe not found"
            exit 1
          }
        } else {
          echo "âœ— Could not find Ahk2Exe release asset"
          exit 1
        }
      shell: pwsh
      
    - name: Compile executable
      run: |
        $ahk2exe = "Compiler\Ahk2Exe.exe"
        
        echo "Starting compilation in silent mode..."
        
        # æŒ‡å®š base file
        $baseFile = "AutoHotkey\AutoHotkey64.exe"
        
        # æ„å»ºå‚æ•°åˆ—è¡¨
        $arguments = @(
          "/in", "MicToggleTool.ahk",
          "/out", "MicToggleTool.exe",
          "/icon", "icons\mic_enabled.ico",
          "/base", $baseFile,
          "/silent"
        )
        
        echo "Running: $ahk2exe with arguments"
        echo "Base file: $baseFile"
        echo "Arguments: $($arguments -join ' ')"
        
        # ä½¿ç”¨ç›´æ¥è°ƒç”¨æ“ä½œç¬¦ (&) æ¥æ‰§è¡Œï¼Œå¹¶æ•è·è¾“å‡º
        try {
          $output = & $ahk2exe $arguments 2>&1
          $exitCode = $LASTEXITCODE
          
          # æ˜¾ç¤ºè¾“å‡º
          if ($output) {
            echo "Ahk2Exe output:"
            echo $output
          }
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸï¼ˆé€šè¿‡è¾“å‡ºåˆ¤æ–­ï¼Œè€Œä¸æ˜¯é€€å‡ºç ï¼‰
          if ($output -match "Successfully compiled") {
            echo "âœ“ Ahk2Exe compilation successful"
          } elseif ($null -ne $exitCode -and $exitCode -ne 0) {
            echo "::error::Ahk2Exe failed with exit code: $exitCode"
            exit 1
          }
        }
        catch {
          echo "::error::An error occurred during compilation: $_"
          exit 1
        }
        
        # ç­‰å¾…æ–‡ä»¶ç³»ç»ŸåŒæ­¥
        Start-Sleep -Seconds 2
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if (Test-Path "MicToggleTool.exe") {
          $size = (Get-Item "MicToggleTool.exe").Length
          echo "âœ“ Compilation successful - Size: $size bytes"
        } else {
          echo "::error::Compilation failed - MicToggleTool.exe not found"
          echo "Listing current directory:"
          Get-ChildItem . | Select-Object Name, Length
          exit 1
        }
      shell: pwsh
      
    - name: Verify build
      id: verify
      run: |
        if (Test-Path "MicToggleTool.exe") {
          $size = (Get-Item "MicToggleTool.exe").Length
          $sizeMB = [math]::Round($size / 1MB, 2)
          echo "SIZE_BYTES=$size" >> $env:GITHUB_OUTPUT
          echo "SIZE_MB=$sizeMB" >> $env:GITHUB_OUTPUT
          echo "Build successful! File size: $size bytes ($sizeMB MB)"
        } else {
          echo "Build failed! MicToggleTool.exe not found"
          exit 1
        }
      shell: pwsh
      
    - name: Calculate SHA256
      id: sha256
      run: |
        $hash = (Get-FileHash -Path "MicToggleTool.exe" -Algorithm SHA256).Hash
        echo "SHA256=$hash" >> $env:GITHUB_OUTPUT
        
        # åˆ›å»º SHA256 æ–‡ä»¶
        $sha256Content = "$hash  MicToggleTool.exe"
        Set-Content "MicToggleTool.exe.sha256" -Value $sha256Content -Encoding ASCII -NoNewline
        
        echo "âœ“ SHA256: $hash"
        echo "âœ“ SHA256 file created: MicToggleTool.exe.sha256"
      shell: pwsh
      
    - name: Generate changelog
      id: changelog
      run: |
        try {
          # è·å–æ‰€æœ‰æ ‡ç­¾
          $allTags = git tag --sort=-version:refname
          
          if ($allTags.Count -eq 0) {
            # æ²¡æœ‰ä»»ä½•æ ‡ç­¾ï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡å‘å¸ƒ
            echo "No existing tags found - First release"
            
            # è·å–æ‰€æœ‰æäº¤è®°å½•
            $commits = git log --pretty=format:"- %s (%h)" --no-merges
            
            if ($commits) {
              $changelog = "é¦–æ¬¡å‘å¸ƒ`n`n" + ($commits -join "`n")
            } else {
              $changelog = "- é¦–æ¬¡å‘å¸ƒ"
            }
          }
          elseif ($allTags.Count -eq 1) {
            # åªæœ‰ä¸€ä¸ªæ ‡ç­¾ï¼ˆå½“å‰è¦å‘å¸ƒçš„ï¼‰ï¼Œè·å–ä»åˆå§‹æäº¤åˆ°ç°åœ¨çš„æ‰€æœ‰è®°å½•
            echo "Only one tag found - Getting all commits"
            
            $commits = git log --pretty=format:"- %s (%h)" --no-merges
            
            if ($commits) {
              $changelog = $commits -join "`n"
            } else {
              $changelog = "- é¦–æ¬¡å‘å¸ƒ"
            }
          }
          else {
            # æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œè·å–æœ€æ–°ä¸¤ä¸ªæ ‡ç­¾ä¹‹é—´çš„æäº¤
            $latestTag = $allTags[0]
            $previousTag = $allTags[1]
            
            echo "Generating changelog from $previousTag to $latestTag"
            
            # è·å–ä¸¤ä¸ªæ ‡ç­¾ä¹‹é—´çš„æäº¤è®°å½•
            $commits = git log "$previousTag..$latestTag" --pretty=format:"- %s (%h)" --no-merges
            
            if ($commits) {
              $changelog = $commits -join "`n"
            } else {
              $changelog = "- æ— æ–°æäº¤"
            }
          }
        }
        catch {
          echo "Error generating changelog: $_"
          $changelog = "- é¦–æ¬¡å‘å¸ƒ"
        }
        
        # ä¿å­˜åˆ°æ–‡ä»¶
        $changelog | Out-File -FilePath "CHANGELOG.txt" -Encoding UTF8 -NoNewline
        
        echo "âœ“ Changelog generated"
        echo "Changelog:"
        echo $changelog
      shell: pwsh
      
    - name: Prepare release body
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $sizeMB = "${{ steps.verify.outputs.SIZE_MB }}"
        $sizeBytes = "${{ steps.verify.outputs.SIZE_BYTES }}"
        $sha256 = "${{ steps.sha256.outputs.SHA256 }}"
        $changelog = Get-Content "CHANGELOG.txt" -Raw -Encoding UTF8
        
        # æ„å»º Release Notes
        $body = "## MicToggleTool v" + $version + "`n`n"
        $body += "### ğŸ“ æ›´æ–°æ—¥å¿—`n`n"
        $body += "$changelog`n`n"
        $body += "### ğŸ“¥ ä¸‹è½½`n`n"
        $body += "- **Windows 64-bit**: [MicToggleTool.exe](https://github.com/cmyyx/MicToggleTool/releases/download/v$version/MicToggleTool.exe)`n"
        $body += "- **SHA256 æ ¡éªŒæ–‡ä»¶**: [MicToggleTool.exe.sha256](https://github.com/cmyyx/MicToggleTool/releases/download/v$version/MicToggleTool.exe.sha256)`n"
        $body += "- **æ–‡ä»¶å¤§å°**: $sizeMB MB ($sizeBytes bytes)`n"
        $body += "- **SHA256**: ``$sha256```n`n"
        $body += "### âœ… æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§`n`n"
        $body += "``````powershell`n"
        $body += "# Windows PowerShell" + "`n"
        $body += "`$hash = (Get-FileHash -Path 'MicToggleTool.exe' -Algorithm SHA256).Hash`n"
        $body += "`$expected = Get-Content 'MicToggleTool.exe.sha256' | ForEach-Object { `$_.Split()[0] }`n"
        $body += "if (`$hash -eq `$expected) { Write-Host 'âœ“ æ ¡éªŒé€šè¿‡' -ForegroundColor Green } else { Write-Host 'âœ— æ ¡éªŒå¤±è´¥' -ForegroundColor Red }`n"
        $body += "```````n`n"
        $body += "### ğŸš€ å¿«é€Ÿå¼€å§‹`n`n"
        $body += "1. ä¸‹è½½ ``MicToggleTool.exe```n"
        $body += "2. ï¼ˆå¯é€‰ï¼‰ä¸‹è½½ ``MicToggleTool.exe.sha256`` å¹¶æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§`n"
        $body += "3. åŒå‡»è¿è¡Œï¼Œæˆäºˆç®¡ç†å‘˜æƒé™`n"
        $body += "4. é€‰æ‹©è¦æ§åˆ¶çš„éº¦å…‹é£è®¾å¤‡`n"
        $body += "5. æŒ‰ F9 åˆ‡æ¢éº¦å…‹é£çŠ¶æ€`n`n"
        $body += "### ğŸ“– å®Œæ•´æ–‡æ¡£`n`n"
        $body += "æŸ¥çœ‹ [README.md](https://github.com/cmyyx/MicToggleTool/blob/main/README.md) äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚`n`n"
        $body += "### ğŸ› é—®é¢˜åé¦ˆ`n`n"
        $body += "å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/cmyyx/MicToggleTool/issues) é¡µé¢æäº¤ã€‚`n"
        
        Set-Content "RELEASE_BODY.md" -Value $body -Encoding UTF8 -NoNewline
        
        echo "âœ“ Release body prepared"
      shell: pwsh
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.TAG }}
        name: v${{ steps.get_version.outputs.VERSION }}
        body_path: RELEASE_BODY.md
        files: |
          MicToggleTool.exe
          MicToggleTool.exe.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
